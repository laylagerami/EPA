compound_sig = cbind(test_df[1],test_df[i]) # Take the gene names and corresponding measurements
write.table(compound_sig,fname,sep="\t",quote=F,row.names=F,col.names=T,append=T) # Write
df = read.table(fname,sep="\t",header=T,row.names=1) # Read in the signature .txt file
TF_genesymbol<-try( # run DoRothEA, confidence levels A, B and C
runDoRothEA(df, regulon=viper_regulon, confidence_level=c('A','B','C')),
silent = T
)
if(inherits(TF_genesymbol,"try-error")){ # If there is an error for some reason, skip the compound
next
}
TF_uniprot<-GeneSymbol2Uniprot(TF_genesymbol, map, 1, 2) # Map to UniProt
folder = paste0(i,"_measurements/") # Set folder name
generate_measfile(measurements=TF_uniprot, topnumber=50, write2folder=folder) # Write TF activities to folder
}
# Stop the cluster
stopCluster(myCluster)
# Script to prepare DoRoTHea TF activities
# Input: Matrix of gene expression data (Rows are genes (Entrez), columns are compounds)
# Output: 1. .txt file for each signature found in the input matrix
#         2. Folder for each compound (compoundname_measurements)
#         with TF activities (meas_50.txt) as UniProt ID
# Import packages
library(CARNIVAL)
library(org.Hs.eg.db)
library(foreach)
library(doParallel)
library(plyr)
library(data.table)
# Initialise cluster
n = 2 # change to number of cores needed
myCluster <- makeCluster(n, type="FORK",outfile="")
registerDoParallel(myCluster)
# Load files for dorothea
file.copy(from=system.file("dorothea_TF_mapping.csv",package="CARNIVAL"),to=getwd(),overwrite=TRUE)
load(file = system.file("BEST_viperRegulon.rdata",package="CARNIVAL"))
map<-read.csv("dorothea_TF_mapping.csv")
#Open matrix
gexfile = "HT29_6h_10uM.csv"
gex_df = fread(gexfile,header=TRUE,sep=",") # First row is python header
gex_df = as.data.frame(gex_df) # Change into df
compound_names = names(gex_df) # Column names are compounds
compound_names = compound_names[!compound_names %in% 'Compound_id'] # Get rid of 'Compound_id'
#Now change gene ids to gene symbols using metadata
gene_info = fread('gene_info.csv',header=TRUE) # Import metadata
gene_info = as.data.frame(gene_info) # Read as df
converted = merge(test_df,gene_info,by.x='Compound_id',by.y='pr_gene_id') # Map to gene symbol
converted_symbols = converted$pr_gene_symbol # Extract symbols
test_df$Compound_id = converted_symbols # Make row names into symbols
compound_names = compound_names[0:10] # test e.g. 10 compounds
# Run
output <-
foreach(i = compound_names) %dopar% { # Loop over every compound
print(i)
fname = paste0(i,".txt") # Set the file name for the signature file
compound_sig = cbind(test_df[1],test_df[i]) # Take the gene names and corresponding measurements
write.table(compound_sig,fname,sep="\t",quote=F,row.names=F,col.names=T,append=T) # Write
df = read.table(fname,sep="\t",header=T,row.names=1) # Read in the signature .txt file
TF_genesymbol<-try( # run DoRothEA, confidence levels A, B and C
runDoRothEA(df, regulon=viper_regulon, confidence_level=c('A','B','C')),
silent = T
)
if(inherits(TF_genesymbol,"try-error")){ # If there is an error for some reason, skip the compound
next
}
TF_uniprot<-GeneSymbol2Uniprot(TF_genesymbol, map, 1, 2) # Map to UniProt
folder = paste0(i,"_measurements/") # Set folder name
generate_measfile(measurements=TF_uniprot, topnumber=50, write2folder=folder) # Write TF activities to folder
}
# Stop the cluster
stopCluster(myCluster)
# Load files for progeny
file.copy(from=system.file("model_NatComm+14_human.csv",package="CARNIVAL"),to=getwd(),overwrite=TRUE)
weight_matrix<-read.csv("model_NatComm+14_human.csv")
View(weight_matrix)
# Import matrix
gexfile = "HT29_6h_10uM.csv"
# Import matrix
gexfile = "HT29_6h_10uM.csv"
gex_df = fread(gexfile,header=TRUE,sep=",") # First row is python header
gex_df = as.data.frame(gex_df) # As df
compound_names = names(gex_df) # Column names are compounds
compound_names = compound_names[!compound_names %in% 'Compound_id'] # Get rid of 'Compound_id'
i = compound_names[[1]]
print(i)
fname <- paste0("/",i, ".txt") # get signature .txt
fname <- paste0(i, ".txt") # get signature .txt
df = read.table(fname,sep="\t",header=TRUE,row.names=1) # Read back in file
df_genenames <- data.frame('gene'=rownames(df),df)
df_genenames
#Run progeny
pathway_scores <- try(
runPROGENy(df_genenames,weight_matrix,z_scores=F),
silent = T)
pathway_scores
#Generate input files
folder = paste0(i,"_measurements/scores_")
scores <- rbind(rownames(pathway_scores),pathway_scores[,1])
scores
write.table(scores,paste0(folder,i,".txt"),col.names=F,row.names=F,quote=F,sep='\t') # save
# Script to prepare PROGENy pathway scores
# Input: Matrix of gene expression data (Rows are genes (Entrez), columns are compounds), and
#        The .txt file for each signature (From prepare_input_parellel.R)
#         And a measurement folder for each compound (From prepare_input_parellel.R)
# Output: PROGEny pathway weights .txt in each compound's measurement folder
# Import packages
library(CARNIVAL)
library(org.Hs.eg.db)
library(foreach)
library(doParallel)
library(plyr)
library(data.table)
# set n to number of cores
myCluster <- makeCluster(n, type="FORK",outfile="")
registerDoParallel(myCluster)
# Load files for progeny
file.copy(from=system.file("model_NatComm+14_human.csv",package="CARNIVAL"),to=getwd(),overwrite=TRUE)
weight_matrix<-read.csv("model_NatComm+14_human.csv")
# Import matrix
gexfile = "HT29_6h_10uM.csv"
gex_df = fread(gexfile,header=TRUE,sep=",") # First row is python header
gex_df = as.data.frame(gex_df) # As df
compound_names = names(gex_df) # Column names are compounds
compound_names = compound_names[!compound_names %in% 'Compound_id'] # Get rid of 'Compound_id'
# test for e.g. 10 compounds
compound_names = compound_names[1:10]
output <-
foreach(i = compound_names) %dopar% {  # loop over each compound
print(i)
fname <- paste0(i, ".txt") # get signature .txt
df = read.table(fname,sep="\t",header=TRUE,row.names=1) # Read back in file
df_genenames <- data.frame('gene'=rownames(df),df) # make df with rownames = gene symbols
#Run progeny
pathway_scores <- try(
runPROGENy(df_genenames,weight_matrix,z_scores=F),
silent = T)
if(inherits(pathway_scores,"try-error")){ # if it fails then skip
next
}
#Generate input files
folder = paste0(i,"_measurements/scores_") # get folder name
scores <- rbind(rownames(pathway_scores),pathway_scores[,1]) # put into correct format
write.table(scores,paste0(folder,i,".txt"),col.names=F,row.names=F,quote=F,sep='\t') # save
}
stopCluster(myCluster)
# Script to prepare PROGENy pathway scores
# Input: Matrix of gene expression data (Rows are genes (Entrez), columns are compounds), and
#        The .txt file for each signature (From prepare_input_parellel.R)
#         And a measurement folder for each compound (From prepare_input_parellel.R)
# Output: PROGEny pathway weights .txt in each compound's measurement folder
# Import packages
library(CARNIVAL)
library(org.Hs.eg.db)
library(foreach)
library(doParallel)
library(plyr)
library(data.table)
# set n to number of cores
myCluster <- makeCluster(n, type="FORK",outfile="")
registerDoParallel(myCluster)
# Load files for progeny
file.copy(from=system.file("model_NatComm+14_human.csv",package="CARNIVAL"),to=getwd(),overwrite=TRUE)
weight_matrix<-read.csv("model_NatComm+14_human.csv")
# Import matrix
gexfile = "HT29_6h_10uM.csv"
gex_df = fread(gexfile,header=TRUE,sep=",") # First row is python header
gex_df = as.data.frame(gex_df) # As df
compound_names = names(gex_df) # Column names are compounds
compound_names = compound_names[!compound_names %in% 'Compound_id'] # Get rid of 'Compound_id'
# test for e.g. 10 compounds
compound_names = compound_names[1:10]
output <-
foreach(i = compound_names) %dopar% {  # loop over each compound
print(i)
fname <- paste0(i, ".txt") # get signature .txt
df = read.table(fname,sep="\t",header=TRUE,row.names=1) # Read back in file
df_genenames <- data.frame('gene'=rownames(df),df) # make df with rownames = gene symbols
#Run progeny
pathway_scores <- try(
runPROGENy(df_genenames,weight_matrix,z_scores=F),
silent = T)
if(inherits(pathway_scores,"try-error")){ # if it fails then skip
next
}
#Generate input files
folder = paste0(i,"_measurements/scores_") # get folder name
scores <- rbind(rownames(pathway_scores),pathway_scores[,1]) # put into correct format
write.table(scores,paste0(folder,i,".txt"),col.names=F,row.names=F,quote=F,sep='\t') # save
}
stopCluster(myCluster)
# Script to prepare PROGENy pathway scores
# Input: Matrix of gene expression data (Rows are genes (Entrez), columns are compounds), and
#        The .txt file for each signature (From prepare_input_parellel.R)
#         And a measurement folder for each compound (From prepare_input_parellel.R)
# Output: PROGEny pathway weights .txt in each compound's measurement folder
# Import packages
library(CARNIVAL)
library(org.Hs.eg.db)
library(foreach)
library(doParallel)
library(plyr)
library(data.table)
# set n to number of cores
n = 2
myCluster <- makeCluster(n, type="FORK",outfile="")
registerDoParallel(myCluster)
# Load files for progeny
file.copy(from=system.file("model_NatComm+14_human.csv",package="CARNIVAL"),to=getwd(),overwrite=TRUE)
weight_matrix<-read.csv("model_NatComm+14_human.csv")
# Import matrix
gexfile = "HT29_6h_10uM.csv"
gex_df = fread(gexfile,header=TRUE,sep=",") # First row is python header
gex_df = as.data.frame(gex_df) # As df
compound_names = names(gex_df) # Column names are compounds
compound_names = compound_names[!compound_names %in% 'Compound_id'] # Get rid of 'Compound_id'
# test for e.g. 10 compounds
compound_names = compound_names[1:10]
output <-
foreach(i = compound_names) %dopar% {  # loop over each compound
print(i)
fname <- paste0(i, ".txt") # get signature .txt
df = read.table(fname,sep="\t",header=TRUE,row.names=1) # Read back in file
df_genenames <- data.frame('gene'=rownames(df),df) # make df with rownames = gene symbols
#Run progeny
pathway_scores <- try(
runPROGENy(df_genenames,weight_matrix,z_scores=F),
silent = T)
if(inherits(pathway_scores,"try-error")){ # if it fails then skip
next
}
#Generate input files
folder = paste0(i,"_measurements/scores_") # get folder name
scores <- rbind(rownames(pathway_scores),pathway_scores[,1]) # put into correct format
write.table(scores,paste0(folder,i,".txt"),col.names=F,row.names=F,quote=F,sep='\t') # save
}
stopCluster(myCluster)
# Create output dir
dir.create(file.path("RESULTS_CARNIVAL"),showWarnings = FALSE)
compound_folders = list.dirs(recursive=FALSE)
compound_dirs
compound_folders
# get ones that have already finished and exclude (checkpointing)
done_folders = list.dirs(path="RESULTS_CARNIVAL",full.names=FALSE,recursive=FALSE)
info = file.info(list.dirs(path="RESULTS_CARNIVAL",recursive=FALSE))
info = info[with(info, order(as.POSIXct(ctime))),]
donecomps = rownames(info)
exclude = tail(donecomps,n=1)
exclude = unlist(strsplit(exclude,"RESULTS_CARNIVAL/"))[2]
done_final = done_folders[!done_folders %in% exclude]
compound_folders
compound = compound_folders[1]
compound
drug = unlist(strsplit(unlist(strsplit(compound,"/"))[2],"_"))[1] # get the compound name
drug
#dir.create(file.path(paste0("RESULTS_CARNIVAL/",drug)),showWarnings = FALSE)
results_dir = paste0("RESULTS_CARNIVAL/",drug)
results_dir
#results_dir = "RESULTS_CARNIVAL/"
tf_activities = list.files(path=compound,pattern="_50.txt",full.names=TRUE)
progeny_pathways = list.files(path=compound,pattern="scores_",full.names=TRUE)
tf_activities
dir.create(file.path(paste0("RESULTS_CARNIVAL/",drug)),showWarnings = FALSE)
# load tf + progeny
tf_activities = list.files(path=compound,pattern="_50.txt",full.names=TRUE)
progeny_pathways = list.files(path=compound,pattern="scores_",full.names=TRUE)
progeny_pathways
install.packages("pkgconfig")
install.packages("data.table")
BiocManager::install("CARNIVAL")
devtools::install_github("saezlab/CARNIVAL")
install_github("saezlab/CARNIVAL@*release")
devtools::install_github("saezlab/CARNIVAL@*release")
setwd("~/OneDrive - University Of Cambridge/EPA/Initial_Investigation/Scripts")
# Script to run CARNIVAL
library(CARNIVAL)
# Get Network
netfilehepg2 = read.csv("../Network_Data/omnipath_full_formatted_hepg2.csv")
netfilefull = read.csv("../Network_Data/omnipath_full_formatted.csv")
colnames(netfilefull) = c('source','Interaction','target')
colnames(netfilehepg2) = c('source','Interaction','target')
write.table(netfilefull,"../Network_Data/omnipath_full_carnival.sif",sep="\t",quote = F,row.names = F)
write.table(netfilehepg2,"../Network_Data/omnipath_hepg2_carnival.sif",sep="\t",quote = F,row.names = F)
netall = "../Network_Data/omnipath_full_carnival.sif"
nethepg2 = "../Network_Data/omnipath_hepg2_carnival.sif"
# get Targets
targets = as.character(read.csv("../Metadata/spiperone_targets_RH.txt",sep="\t")$Target)
targets = unlist(strsplit(targets,", "))
# List Dirs
dirs = list.dirs("../Transcriptomics_Data/tf_progeny",full.names = T,recursive = T)
dirs = dirs[2:8] # get rid of first dir (root dir)
dirs
dir = dirs[1]
# get both files
files = list.files(dir,full.names = T)
# get cond
cond = strsplit(strsplit(files[1],"/")[[1]][4],"_measurements")[[1]][1]
# extract tf and progeny file
tf = files[grepl("meas_",files)]
progeny = files[grepl("scores_",files)]
#INV, FULL
r1 = runCARNIVAL(inputFile = progeny,
measFile = tf,
netFile = netall,
CplexPath = "../../../../../../Applications/CPLEX_Studio1210/cplex/bin/x86-64_osx/cplex",
CARNIVAL_example=NULL,
inverseCR = F)
#INV, FULL
r1 = runCARNIVAL(inputFile = progeny,
measFile = tf,
netFile = netall,
CplexPath = "../../../../../../Applications/CPLEX_Studio1210/cpoptimizer/bin/x86-64_osx/cplex",
CARNIVAL_example=NULL,
inverseCR = F)
runCARNIVAL
#INV, FULL
r1 = runCARNIVAL(inputFile = progeny,
measFile = tf,
netFile = netall,
CplexPath = "../../../../../../Applications/CPLEX_Studio1210/cplex/bin/x86-64_osx/cplex",
CARNIVAL_example=NULL,
inverseCR = F)
tf
# extract tf and progeny file
tf = read.table(files[grepl("meas_",files)])
View(tf)
# extract tf and progeny file
tf = read.table(files[grepl("meas_",files)],header = T)
View(tf)
progeny = read.table(files[grepl("scores_",files)],header=T)
View(progeny)
View(netfilefull)
netfilehepg2$Interaction = ifelse(netfilehepg2$Interaction=="inhibits",-1,1)
View(netfilehepg2)
netfilefull$Interaction = ifelse(netfilefull$Interaction=="inhibits",-1,1)
nrow(progeny)
nrow(tf)
if(nrow(weightObj)!=nrow(measObj)){
print('hello')
}
if(nrow(progeny)!=nrow(tf)){
print('hello')
}
if(nrow(progeny)!=nrow(tf)){
print('hello')
}
weightObj = read.table(files[grepl("scores_",files)],header=T)
weightObj[1]
# extract tf and progeny file
measObj = read.table(files[grepl("meas_",files)],header = T)
weightObj = read.table(files[grepl("scores_",files)],header=T)
if (nrow(weightObj) != nrow(measObj)) {
print('hello')
}
View(measObj)
colnames(measObj)
test = unique(as.character(netfilefull$source))
intersect(test,colnames(measObj))
load("/Users/lh605/Downloads/progenyMembers.RData")
View(progenyMembers)
View(progeny)
View(progenyMembers)
load(file=system.file("progenyMembers.RData",package="CARNIVAL"))
assignPROGENyScores <- function (progeny = progeny, progenyMembers = progenyMembers,
id = "gene", access_idx = 1)
{
if (id == "uniprot") {
idx <- which(names(progenyMembers) == "uniprot")
progenyMembers <- progenyMembers[[idx]]
}
else {
idx <- which(names(progenyMembers) == "gene")
progenyMembers <- progenyMembers[[idx]]
}
members <- matrix(data = , nrow = 1, ncol = 2)
pathways <- colnames(progeny)
ctrl <- intersect(x = access_idx, y = 1:nrow(progeny))
if (length(ctrl) == 0) {
stop("The indeces you inserted do not correspond to \n              the number of rows/samples")
}
for (ii in 1:length(pathways)) {
mm <- progenyMembers[[which(names(progenyMembers) ==
pathways[ii])]]
for (jj in 1:length(mm)) {
members <- rbind(members, c(pathways[ii], mm[jj]))
}
}
members <- members[-1, ]
scores <- matrix(data = , nrow = nrow(progeny), ncol = nrow(members))
colnames(scores) <- members[, 2]
rownames(scores) <- rownames(progeny)
members <- unique(members)
for (i in 1:ncol(scores)) {
for (j in 1:nrow(scores)) {
scores[j, i] <- as.numeric(progeny[j, members[which(members[,
2] == colnames(scores)[i]), 1]])
}
}
pxList <- list()
for (ii in 1:length(access_idx)) {
pxList[[length(pxList) + 1]] <- as.data.frame(t(as.matrix(scores[access_idx[ii],
])))
}
names(pxList) <- rownames(progeny)[ctrl]
return(pxList)
}
progenylist = assignPROGENyScores(progeny = t(weightObj),
progenyMembers = progenyMembers,
id = "gene",
access_idx = 1)
# extract tf and progeny file
measObj = read.table(files[grepl("meas_",files)],header=T)
weightObj = read.table(files[grepl("scores_",files)],header=T)
progenylist = assignPROGENyScores(progeny = t(weightObj),
progenyMembers = progenyMembers,
id = "gene",
access_idx = 1)
View(weightObj)
idx <- which(names(progenyMembers) == "gene")
progenyMembers <- progenyMembers[[idx]]
progenyMembers
members <- matrix(data = , nrow = 1, ncol = 2)
pathways <- colnames(progeny)
ctrl <- intersect(x = access_idx, y = 1:nrow(progeny))
access_idx=1
ctrl <- intersect(x = access_idx, y = 1:nrow(progeny))
ctrl
pathways
members
progeny=t(weightObj)
View(progeny)
idx <- which(names(progenyMembers) == "gene")
progenyMembers <- progenyMembers[[idx]]
idx
load(file=system.file("progenyMembers.RData",package="CARNIVAL"))
idx <- which(names(progenyMembers) == "gene")
progenyMembers <- progenyMembers[[idx]]
members <- matrix(data = , nrow = 1, ncol = 2)
pathways <- colnames(progeny)
ctrl <- intersect(x = access_idx, y = 1:nrow(progeny))
ctrl
if (length(ctrl) == 0) {
stop("The indeces you inserted do not correspond to \n              the number of rows/samples")
}
for (ii in 1:length(pathways)) {
mm <- progenyMembers[[which(names(progenyMembers) ==
pathways[ii])]]
for (jj in 1:length(mm)) {
members <- rbind(members, c(pathways[ii], mm[jj]))
}
}
mm <- progenyMembers[[which(names(progenyMembers) ==
pathways[ii])]]
progenyMembers
length(pathways)
progeny
progeny=weightObj
load(file=system.file("progenyMembers.RData",package="CARNIVAL"))
progeny=weightObj
idx <- which(names(progenyMembers) == "gene")
progenyMembers <- progenyMembers[[idx]]
members <- matrix(data = , nrow = 1, ncol = 2)
pathways <- colnames(progeny)
ctrl <- intersect(x = access_idx, y = 1:nrow(progeny))
ctrl
members
pathways
for (ii in 1:length(pathways)) {
mm <- progenyMembers[[which(names(progenyMembers) ==
pathways[ii])]]
for (jj in 1:length(mm)) {
members <- rbind(members, c(pathways[ii], mm[jj]))
}
}
members <- members[-1, ]
scores <- matrix(data = , nrow = nrow(progeny), ncol = nrow(members))
colnames(scores) <- members[, 2]
rownames(scores) <- rownames(progeny)
members <- unique(members)
for (i in 1:ncol(scores)) {
for (j in 1:nrow(scores)) {
scores[j, i] <- as.numeric(progeny[j, members[which(members[,
2] == colnames(scores)[i]), 1]])
}
}
pxList <- list()
for (ii in 1:length(access_idx)) {
pxList[[length(pxList) + 1]] <- as.data.frame(t(as.matrix(scores[access_idx[ii],
])))
}
names(pxList) <- rownames(progeny)[ctrl]
View(pxList)
progenylist = assignPROGENyScores(progeny = weightObj,
progenyMembers = progenyMembers,
id = "gene",
access_idx = 1)
# extract tf and progeny file
measObj = read.table(files[grepl("meas_",files)],header=T)
weightObj = read.table(files[grepl("scores_",files)],header=T)
progenylist = assignPROGENyScores(progeny = weightObj,
progenyMembers = progenyMembers,
id = "gene",
access_idx = 1)
# extract tf and progeny file
load(file=system.file("progenyMembers.RData",package="CARNIVAL"))
measObj = read.table(files[grepl("meas_",files)],header=T)
weightObj = read.table(files[grepl("scores_",files)],header=T)
progenylist = assignPROGENyScores(progeny = weightObj,
progenyMembers = progenyMembers,
id = "gene",
access_idx = 1)
progenylist$`1`
progenylist
progenylist$1
